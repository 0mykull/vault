<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vault ¬∑ Your Second Brain</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            vault: {
              bg: '#050816',
              panel: '#0f172a',
            }
          },
          boxShadow: {
            vault: '0 20px 120px rgba(15,23,42,0.45)'
          }
        }
      }
    }
  </script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-4xl mx-auto px-4 py-10 space-y-8">
    <header class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
      <div class="flex items-center gap-3">
        <span class="text-3xl" aria-hidden="true">üîê</span>
        <div>
          <h1 class="text-3xl font-semibold">Vault</h1>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div id="sync-indicator" class="inline-flex items-center gap-2 text-xs text-slate-400">
          <svg id="sync-spin" class="w-4 h-4 text-slate-300 animate-spin hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="9" stroke-width="1.5" stroke-linecap="round" stroke-dasharray="42"/>
          </svg>
          <svg id="sync-check" class="w-4 h-4 text-emerald-400 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="m5 12 4 4L19 6" />
          </svg>
          <span id="sync-label">Idle</span>
        </div>
        <div class="relative" id="settings-wrapper">
          <button id="settings-toggle" type="button" class="rounded-full border border-white/10 px-3 py-2 text-xs uppercase tracking-[0.3em] text-slate-300 hover:text-white">Settings</button>
          <div id="settings-panel" class="hidden absolute right-0 mt-2 w-64 rounded-2xl border border-white/10 bg-slate-900/95 backdrop-blur shadow-lg text-sm text-slate-200">
            <div class="border-b border-white/5 px-4 py-3">
              <p class="font-semibold text-slate-100 text-xs uppercase tracking-[0.3em]">Help</p>
              <p class="mt-2 text-xs leading-relaxed text-slate-400">Use <strong>New note</strong> to capture, <strong>Recall</strong> to ask Memory. Click any card to expand, pin urgent notes, and watch the sync state up top.</p>
            </div>
            <button class="w-full text-left px-4 py-3 text-rose-300 hover:bg-white/5 flex items-center justify-between text-xs uppercase tracking-[0.3em]" hx-post="/notes/clear" hx-target="#notes-grid" hx-swap="outerHTML">
              Clear notes
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6m0 12L6 6" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </header>

    <div class="flex flex-wrap justify-center gap-4">
      <button id="new-toggle" type="button" class="button-pill button-large" aria-expanded="false">New note</button>
      <button id="recall-toggle" type="button" class="button-pill button-large" aria-expanded="false">Recall</button>
    </div>

    <section id="new-panel" class="hidden rounded-3xl border border-white/5 bg-slate-900/60 p-5 space-y-4 max-w-2xl mx-auto w-full">
      <form id="note-form" class="space-y-4" hx-post="/notes" hx-target="#notes-grid" hx-swap="outerHTML" hx-indicator="#note-loading">
        <input type="text" name="title" placeholder="Title" class="w-full rounded-2xl bg-slate-950/70 border border-white/10 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-slate-400/40" autocomplete="off">
        <textarea name="content" rows="3" placeholder="Description" class="w-full rounded-2xl bg-slate-950/70 border border-white/10 px-4 py-4 text-base focus:outline-none focus:ring-2 focus:ring-slate-400/40 resize-y" data-autogrow="true"></textarea>
        <div class="flex flex-wrap gap-4 items-center text-sm text-slate-300">
          <label class="flex items-center gap-2">Color
            <select name="color" class="rounded-xl bg-slate-950/70 border border-white/10 px-3 py-2">
              {% for color in color_choices %}
              <option value="{{ color }}">{{ color.title() }}</option>
              {% endfor %}
            </select>
          </label>
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" name="pinned" class="rounded bg-slate-900 border-white/30 text-slate-200 focus:ring-0"> Pin
          </label>
          <button type="submit" class="ml-auto inline-flex items-center gap-2 rounded-2xl bg-white/10 px-4 py-2 text-sm font-semibold text-white hover:bg-white/20">
            Save
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14m-7-7 7 7-7 7" />
            </svg>
          </button>
        </div>
        <div id="note-loading" class="htmx-indicator flex items-center gap-2 text-xs text-slate-400" style="display:none;">
          <svg class="w-3.5 h-3.5 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="9" stroke-width="1.5" stroke-linecap="round" stroke-dasharray="42"/>
          </svg>
          <span>Saving‚Ä¶</span>
        </div>
      </form>
    </section>

    <section id="recall-panel" class="hidden rounded-3xl border border-white/5 bg-slate-900/60 p-5 space-y-4 max-w-2xl mx-auto w-full">
      <form class="space-y-3" hx-post="/memory/query" hx-target="#memory-response" hx-swap="innerHTML" hx-indicator="#memory-indicator">
        <textarea id="memory-input" name="question" rows="2" placeholder="What's on my grocery list?" class="w-full rounded-2xl bg-slate-950/70 border border-white/10 px-4 py-4 text-base focus:outline-none focus:ring-2 focus:ring-slate-400/40 resize-y" data-autogrow="true"></textarea>
        <div class="flex flex-wrap gap-3 items-center">
          <button type="submit" class="inline-flex items-center gap-2 rounded-2xl bg-white/10 px-4 py-2 text-sm font-semibold text-white hover:bg-white/20">
            Ask
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 8.25h13.5M16.5 8.25 15 6m1.5 2.25L15 10.5M21 15.75H7.5M7.5 15.75 9 18m-1.5-2.25L9 13.5" />
            </svg>
            <span id="memory-button-spinner" class="hidden w-3.5 h-3.5 relative">
              <span class="absolute inset-0 rounded-full border border-white/30 border-t-transparent animate-spin"></span>
            </span>
          </button>
          <button type="button" id="memory-clear" class="text-xs uppercase tracking-[0.3em] text-slate-400">Clear</button>
        </div>
      </form>
      <div id="memory-indicator" class="htmx-indicator flex items-center gap-2 text-xs text-slate-400" style="display:none;">
        <svg class="w-3.5 h-3.5 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="12" r="9" stroke-width="1.5" stroke-linecap="round" stroke-dasharray="42"/>
        </svg>
        <span>Gemini is thinking‚Ä¶</span>
      </div>
      <div id="memory-response" class="rounded-2xl bg-slate-950/70 border border-white/10 p-4 text-sm text-slate-100 whitespace-pre-wrap">
        {% with memory=memory_initial %}
          {% include 'partials/memory_response.html' %}
        {% endwith %}
      </div>
    </section>

    <section id="notes-grid">
      {% include 'partials/note_grid.html' %}
    </section>
  </div>

  <script>
    document.querySelectorAll('[data-autogrow="true"]').forEach((textarea) => {
      const resize = () => {
        textarea.style.height = 'auto';
        textarea.style.height = `${textarea.scrollHeight}px`;
      };
      textarea.addEventListener('input', resize);
      resize();
    });

    const panelMap = {
      new: {
        button: document.getElementById('new-toggle'),
        panel: document.getElementById('new-panel'),
      },
      recall: {
        button: document.getElementById('recall-toggle'),
        panel: document.getElementById('recall-panel'),
      },
    };

    const setPanel = (name) => {
      Object.entries(panelMap).forEach(([key, cfg]) => {
        if (!cfg.button || !cfg.panel) {
          return;
        }
        const active = key === name;
        cfg.panel.classList.toggle('hidden', !active);
        cfg.button.setAttribute('aria-expanded', String(active));
        cfg.button.classList.toggle('button-active', active);
      });
    };

    Object.entries(panelMap).forEach(([name, cfg]) => {
      if (!cfg.button) return;
      cfg.button.addEventListener('click', () => {
        const alreadyActive = cfg.button.classList.contains('button-active');
        setPanel(alreadyActive ? null : name);
      });
    });

    const memoryClear = document.getElementById('memory-clear');
    const memoryInput = document.getElementById('memory-input');
    if (memoryClear && memoryInput) {
      memoryClear.addEventListener('click', () => {
        memoryInput.value = '';
        memoryInput.focus();
      });
    }

    document.addEventListener('click', (event) => {
      const card = event.target.closest('.note-card');
      if (!card) {
        return;
      }
      if (event.target.closest('button')) {
        return;
      }
      card.classList.toggle('note-card--open');
    });

    const syncSpin = document.getElementById('sync-spin');
    const syncCheck = document.getElementById('sync-check');
    const syncLabel = document.getElementById('sync-label');
    let syncTimer = null;

    const showSync = (state, message) => {
      if (!syncSpin || !syncCheck || !syncLabel) return;
      syncLabel.textContent = message;
      if (state === 'spin') {
        syncSpin.classList.remove('hidden');
        syncCheck.classList.add('hidden');
      } else if (state === 'check') {
        syncSpin.classList.add('hidden');
        syncCheck.classList.remove('hidden');
      } else {
        syncSpin.classList.add('hidden');
        syncCheck.classList.add('hidden');
      }
    };

    document.body.addEventListener('htmx:afterRequest', (event) => {
      if (syncTimer) {
        clearTimeout(syncTimer);
        syncTimer = null;
      }
      showSync('spin', 'Syncing‚Ä¶');
      if (event.detail.failed) {
        showSync('idle', 'Sync issue');
        return;
      }
      syncTimer = setTimeout(() => {
        showSync('check', 'Synced');
        syncTimer = setTimeout(() => showSync('idle', 'Idle'), 1200);
      }, 300);
    });

    const settingsToggle = document.getElementById('settings-toggle');
    const settingsPanel = document.getElementById('settings-panel');
    const settingsWrapper = document.getElementById('settings-wrapper');

    const closeSettings = () => {
      settingsPanel?.classList.add('hidden');
      settingsToggle?.setAttribute('aria-expanded', 'false');
    };

    settingsToggle?.addEventListener('click', () => {
      if (!settingsPanel) return;
      const hidden = settingsPanel.classList.contains('hidden');
      if (hidden) {
        settingsPanel.classList.remove('hidden');
        settingsToggle.setAttribute('aria-expanded', 'true');
      } else {
        closeSettings();
      }
    });

    document.addEventListener('click', (event) => {
      if (!settingsWrapper) return;
      if (!settingsWrapper.contains(event.target)) {
        closeSettings();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeSettings();
      }
    });

    const memoryButtonSpinner = document.getElementById('memory-button-spinner');
    document.body.addEventListener('htmx:beforeRequest', (event) => {
      if (!event.target || event.target.getAttribute('hx-target') !== '#memory-response') {
        return;
      }
      memoryButtonSpinner?.classList.remove('hidden');
    });

    document.body.addEventListener('htmx:afterRequest', (event) => {
      if (!event.target || event.target.getAttribute('hx-target') !== '#memory-response') {
        return;
      }
      memoryButtonSpinner?.classList.add('hidden');
    });
  </script>

  <style>
    .button-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 9999px;
      border: 1px solid rgba(255,255,255,0.1);
      padding: 0.5rem 1.25rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: rgba(226,232,240,0.95);
      background-color: rgba(255,255,255,0.05);
      transition: background-color 150ms ease;
    }
    .button-pill:hover {
      background-color: rgba(255,255,255,0.12);
    }
    .button-large {
      min-width: 10rem;
      font-size: 1rem;
      padding: 0.75rem 2.5rem;
    }
    .button-active {
      background-color: rgba(255,255,255,0.2) !important;
      color: #fff !important;
    }
    .note-card {
      cursor: pointer;
      transition: border-color 150ms ease, transform 150ms ease;
      max-height: 13rem;
      overflow: hidden;
    }
    .note-card:hover {
      border-color: rgba(255,255,255,0.2);
      transform: translateY(-2px);
    }
    .note-card--open {
      max-height: none;
    }
  </style>
</body>
</html>
